# am (audit machine)

Netwrix для бедных, работало сносно на количестве серверов ~5

## Работа программы

Программа анализирует и выдает (отправляет на почту) два вида информации  

### 1 тип:  

основан на сравнении некоей эталонной информацией с информацией полученной в ходе предварительного теста.  

- -u изменение списка пользователей, определенных в AD  
- -g изменение списка пользователей, входящих в группы администраторов, которыми считаются группы вида "*admin*" "*Админ*"  
- -d изменение настроек DHCP сервера  
- -s изменения в списках автозапуска, которые формируются программой autorunsc из состава пакета Sysinternals, 
которая анализирует, наверное, все возможные места запуска и все виды запускаемого кода в Windows  

### 2 тип:
  предоставляет в удобном (Excel с возможностью фильтрации и т.д.) виде информацию из логов  

- -l входы пользователей, попадающие в лог Security серверов по определяемому списку  
- -t логов программы tcplogview, которая собирает весь TCP трафик серверов по списку. 
Для удобства оставляется только часть трафика из-за пределов и за пределы ЛВС  
- -i лог входов терминального сервера, должен пересекаться с l, работает... непонятно, и поэтому в режиме * отключен  

В зависимости от заданных параметров, программа получает информацию, обрабатывает ее и результаты направляет на почту. 
Промежуточные _значимые_ результаты накапливаются в папке $audit_path для дальнейшего анализа. 
Файлы имеют имена, образованные от имен соответствующих начальных файлов с добавлением даты.  

При устанволенной переменной $isExcel (вариант с работой через установленный excel)  через task sheduler 
запускаются только сборщики информации 1 типа.  
`am.cmd` - для запуска программы из task sheduler  
`am.cmd 2` - для запуска оставшихся сборщиков в ручном режиме.  
для работы программы требуются административные права (что очевидно, ввиду информации собираемой ею)  

Для визуального сравнения файлов удобны различные программы, например compareIT (https://www.grigsoft.com/wincmp3.htm).
Пользуюсь ею, правда еще v2.88 из-за ее малого размера (<1M).
Визуальное сравнения может понадобится для более детального изучения изменений, т.к. diff файлы, отсылаемые на почту 
не всегда наглядны.  

ps  
1. на мой взгляд, этот скриптик легко можно адаптировать под многое, если не все что угодно....  
2. периодичность запусков, очевидно, имеет минусы. Наример, не будут отражены многие (не все, впрочем) 
изменения в случае если они были проведены, а затем отменены....  

## Ключи запуска программы

usage: am.ps1 [[-a|-am_param] <*|udaslti>]  
  -a, -am_param выбор режимов работы, можно не указывать  
    * все тесты (по умолчанию)  
    1 тесты 1 типа  
    2 тесты 2 типа  
    u список всех пользователей  
    d настройки DHCP сервера  
    g члены групп типа "*admin*" "*Админ*"  
    s автозапуск на серверах по списку $server_list  
    l логи с серверов  
    t логи tcplogview  
    i лог входов терминального сервера  

## установка программы

1. Прочитать содержимое этого файла  
2. на компьютере, где будеь выполняться am требуется:  
2.1. наличие powershell, желательно >= v5.1 (в совр. ОС это уже по умолчанию)  
2.2. установить модуль Import-Excel (желательно, но не обязательно, если есть Excel).  
Для установки последнего:  
       распаковать в любое место ImportExcel-master.zip (https://www.powershellgallery.com/packages/ImportExcel)  
       запустить из него InstallModule.ps1 (`powershell -file InstallModule.ps1`)  
2.3. установить LogParser.msi (https://www.microsoft.com/en-my/download/details.aspx?id=24659)  
2.4. скопировать в папку доступную в PATH autorunsc.exe (https://learn.microsoft.com/en-us/sysinternals/downloads/autoruns)  
2.5. создать папку $audit_path (где угодно, должна быть доступна по сети, доступ на запись для администратора)  
2.6. содержимое папки am скопировать в масто где будет хранится am  
2.7. изменить переменные в скрипте am.ps1, находящиеся в блоке между  
    /# конфигурационные переменные START  
           И  
    /# конфигурационные переменные END  

3. на всех серверах из $server_list установить tcplogview, для этого скопировать на эти сервера папку 
tcplogview и запустить install.cmd  после этого папку можно удалить  

3.1. на всех серверах из $server_list установить WinRM  для этого на них из под powershell запустить команду:  
`enable-psremoting -force`  

4. создать начальные файлы для сбора информации 1 типа. Для этого запустить am.ps1 с параметром 0:  
   `powershell.exe -file .\am.ps1 0`  
   После чего  в папке $audit_path должны образоваться файлы  
     admin.txt  
     dhcp.xml  
     user.csv  
     и файлы вида ar-ИмяСервера.txt, в моем случае, например, такие:  
     ar-srv-ad.txt  
     ar-srv-bc.txt  
     ar-srv-term.txt  
5. отредактировать am.cmd, указав путь к powershell и путь, где будет создавться лог файл am.log, в который будет 
писаться вывод скрипта (ошибки).  
6. настроить запуск am.cmd через "Task Scheduler", для работы требуются административные права  
7. если все нормально, на почту должны приходиь результаты работы am.  

## History ;)
ver 1.0 первый запуск  
ver 1.1 psexec теперь не нужен, используем invoke-command, на серверах требуется winRM  
ver 1.2 запуск не обязательно с DHCP-сервера и AD  
ver 1.3 excel не нужен, используется модуль import-excel, навеяно тем фактом,  
       что на серверах excel ненужен, да и через шедулер запуск конвертации в excel не хотел работать  
ver 1.3.1 изменен параметр запуска контроля административных групп a на g  
